<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PagoYo â€” Cliente (Demo)</title>
  <style>
    :root{--teal:#0F766E;--orange:#E67E22}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,Arial,sans-serif;color:#111;background:#fff}
    header{background:var(--teal);color:#fff;padding:12px}
    header .bar{max-width:920px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
    main{max-width:920px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:14px;box-shadow:0 1px 4px rgba(0,0,0,.06)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:8px 0}
    .pill{background:#F4F6F8;border:1px solid #e5e7eb;border-radius:20px;padding:6px 10px;font-size:12px;color:#0F766E}
    .btn{background:var(--teal);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .opt{border:1px solid #e5e7eb;border-radius:10px;padding:8px 12px;cursor:pointer}
    ul{list-style:none;padding:0;margin:0} li{padding:10px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .controls{display:flex;align-items:center;gap:8px}
    .qty{min-width:24px;text-align:center;display:inline-block}
    .right{margin-left:auto}
    input[type="text"]{border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px}
    .flash{animation:flash .6s ease-out} @keyframes flash{from{box-shadow:0 0 0 rgba(15,118,110,0)}to{box-shadow:0 0 0 10px rgba(15,118,110,.12)}}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#111;color:#fff;padding:10px 14px;border-radius:10px}
   .btn[disabled], .method.disabled{opacity:.4;pointer-events:none}
.method.active{outline:2px solid #0F766E}
 
  </style>
</head>
<body>
  <header><div class="bar"><strong>PagoYo â€” Cliente</strong><a href="../" style="color:#fff;text-decoration:none">â¬… Inicio</a></div></header>

  <div style="text-align:center;background:#F4F6F8;padding:10px 0;">
    <label for="mesaSelect" style="font-weight:700;color:#0F766E;">Mesa:</label>
    <select id="mesaSelect" style="padding:6px 10px;border-radius:10px;border:1px solid #ccc;">
      <option value="6" selected>Mesa 6</option>
      <option value="5">Mesa 5</option>
      <option value="4">Mesa 4</option>
    </select>
  </div>
  <div id="syncPill" style="text-align:center;font-size:13px;margin:6px 0;color:#0F766E">
    Mesa <strong id="pillMesa">6</strong> Â· <span id="pillEstado">esperando ticketâ€¦</span>
  </div>
<section id="introCard" class="card" style="max-width:920px;margin:12px auto;">
  <div style="text-align:center;display:grid;gap:12px">
    <div style="font-size:18px;font-weight:800;color:#0F766E">Â¿CÃ³mo quieres pagar?</div>
    <div style="color:#555">Elige la forma de repartir tu parte del ticket.</div>
    <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
      <button id="btnModeSplit" class="btn" style="background:#111">Pagar a medias con todos</button>
      <button id="btnModeMine" class="btn">Pagar solo lo mÃ­o</button>
    </div>
  </div>
</section>

  <main id="main" style="display:none">  <!-- estaba <main> -->
  â€¦
</main>

    <section class="card">
      <div class="row"><strong>Total mesa:</strong> <span id="mesaTotal">â€”</span></div>
      <ul id="itemsList"></ul>
      <div class="row" style="flex-wrap:wrap;gap:12px">
        <div><span>Mi importe:</span> <strong id="myTotal">0,00 â‚¬</strong></div>
       <div class="right" style="display:flex;align-items:center;gap:8px">
  <input id="customerName" type="text" placeholder="Tu nombre (obligatorio)" />
  <button class="opt method btn" data-method="Efectivo"  type="button">ðŸ’¶ Efectivo</button>
  <button class="opt method btn" data-method="Tarjeta"   type="button">ðŸ’³ Tarjeta</button>
  <button id="confirmBtn" class="btn" disabled>Confirmar pago</button>
</div>

          <input id="customerName" type="text" placeholder="Tu nombre (opcional)" />
          <span class="opt" data-method="Efectivo">Efectivo</span>
          <span class="opt" data-method="Tarjeta">Tarjeta</span>
          <button id="confirmBtn" class="btn" disabled>Confirmar pago</button>
        </div>
      </div>
    </section>
  </main>

  <script>
  // ===== Bus robusto (BroadcastChannel con fallback a localStorage) =====
  function makeBus(name, onMessage){
    const HAS_BC = 'BroadcastChannel' in window;
    if (HAS_BC){
      const bc = new BroadcastChannel(name);
      if (onMessage) bc.onmessage = (e)=>onMessage(e.data||{});
      return { post:(d)=>bc.postMessage(d), close:()=>bc.close() };
    } else {
      if (onMessage){
        window.addEventListener('storage',(e)=>{
          if (e.key===name && e.newValue){ try{ onMessage(JSON.parse(e.newValue)); }catch(_){ } }
        });
      }
      return { post:(d)=>{ try{ localStorage.setItem(name, JSON.stringify(d)); }catch(_){ } }, close:()=>{} };
    }
  }
  const bus = makeBus('pagoyo_demo');

  // ===== Utilidades y refs
  const fmt = (n)=> (n||0).toFixed(2).replace('.',',') + ' â‚¬';
  const euroToNum = (s)=> parseFloat((s||'0').toString().replace(/\./g,'').replace(',','.').replace(/[^\d.]/g,''))||0;

  const list = document.getElementById('itemsList');
  const mesaTotalEl = document.getElementById('mesaTotal');
  const myTotalEl = document.getElementById('myTotal');
  const confirmBtn = document.getElementById('confirmBtn');
  // ===== flujo y pantallas
const mainEl   = document.getElementById('main');
const introEl  = document.getElementById('introCard');
const btnSplit = document.getElementById('btnModeSplit');
const btnMine  = document.getElementById('btnModeMine');

let selectedMethod = null;

function showIntro(){
  introEl.style.display = 'block';
  mainEl.style.display  = 'none';
}
function showMine(){
  introEl.style.display = 'none';
  mainEl.style.display  = 'block';
  // al entrar, obligamos a poner nombre antes de poder elegir mÃ©todo
  syncFlowState();
}
 btnMine.addEventListener('click', showMine);

// De momento, solo aviso y seguimos con el paso 2 despuÃ©s
btnSplit.addEventListener('click', ()=>{
  alert('Modo "pagar a medias" se activa en el siguiente paso. Usa "Pagar solo lo mÃ­o" para la demo.');
});
 
  const nameInput = document.getElementById('customerName');
  const pillMesa = document.getElementById('pillMesa');
  const pillEstado = document.getElementById('pillEstado');

  // Estructura de lÃ­nea
  const items = []; // [{ el, name, price, total, selected }]

  function refreshUI(){
    let mt = 0;
    items.forEach(i=>{ mt += i.selected * i.price; });
    myTotalEl.textContent = fmt(mt);
    confirmBtn.disabled = mt <= 0;
  }

  function ensureLine(name, price){
    let li = [...document.querySelectorAll('#itemsList > li')].find(x=>x.dataset.name===name);
    if (!li){
      li = document.createElement('li');
      li.dataset.name = name;
      li.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:4px">
          <div><strong>${name}</strong>
            <span class="pill" style="margin-left:6px">${price.toFixed(2).replace('.',',')} â‚¬</span>
          </div>
          <div class="meta" style="font-size:12px;color:#555">Quedan <strong class="rem">0</strong> de <strong class="tot">0</strong></div>
        </div>
        <div class="controls">
          <button class="optQty" data-act="-">âˆ’</button>
          <span class="qty">0</span>
          <button class="optQty" data-act="+">+</button>
          <div class="lineTotal right">0,00 â‚¬</div>
        </div>`;
      list.appendChild(li);
      items.push({ el: li, name, price, total: 0, selected: 0 });
    }
    return li;
  }

  function updateLineMeta(obj){
    const rem = Math.max(0, (obj.total||0) - (obj.selected||0));
    obj.el.querySelector('.rem').textContent = rem;
    obj.el.querySelector('.tot').textContent = obj.total || 0;
    obj.el.querySelector('.qty').textContent = obj.selected || 0;
    obj.el.querySelector('.lineTotal').textContent = fmt((obj.selected||0) * obj.price);
  }

  // ===== Recibir ticket del TPV
  makeBus('pagoyo_demo', (d)=>{
    try{
      // Filtro por mesa robusto (solo dÃ­gitos por si viene "Mesa 6")
      const mesaSel = (document.getElementById('mesaSelect')?.value || '6').toString().replace(/\D/g,'');
      const msgMesa = (d.mesa || '6').toString().replace(/\D/g,'');
      if (msgMesa && mesaSel && msgMesa !== mesaSel) return;

      if (d.type === 'tpv_ticket_update') applyTPVUpdate(d);
      if (d.type === 'tpv_ticket_close'){
        list.style.opacity = .6; list.style.pointerEvents = 'none';
        pillEstado.textContent = 'ticket cerrado'; confirmBtn.disabled = true;
        const t=document.createElement('div');t.className='toast';t.textContent='Ticket cerrado desde TPV';document.body.appendChild(t);
        setTimeout(()=>{t.style.transition='opacity .25s, transform .25s';t.style.opacity=0;t.style.transform='translateY(-8px)';},1500);
        setTimeout(()=>t.remove(),1800);
      }
    }catch(err){ console.error('Cliente onmessage', err); }
  });

  function applyTPVUpdate(payload){
    try{
      // Reinicia totales/selecciÃ³n y asegura lÃ­neas
      items.forEach(i=>{ i.total = 0; i.selected = 0; updateLineMeta(i); });
      (payload.items||[]).forEach(it=>{
        const price = parseFloat(it.price);
        const li = ensureLine(it.name, price);
        const obj = items.find(x=>x.el===li);
        obj.total = parseInt(it.qty||0,10);
        obj.selected = 0;
        updateLineMeta(obj);
      });

      mesaTotalEl.textContent = payload.total || 'â€”';
      list.style.opacity = 1; list.style.pointerEvents = 'auto';
      pillEstado.textContent = 'sincronizado';
      list.classList.add('flash'); setTimeout(()=>list.classList.remove('flash'),600);
      refreshUI();
    }catch(err){ console.error('applyTPVUpdate error:', err); }
  }

  // Inicial en blanco
  items.forEach(i=>{ i.total = 0; i.selected = 0; updateLineMeta(i); });
  list.style.opacity = .6; list.style.pointerEvents = 'none';
  mesaTotalEl.textContent = 'â€”';
  refreshUI();

  // Cambios de mesa
  document.getElementById('mesaSelect').addEventListener('change', ()=>{
    const m = document.getElementById('mesaSelect').value;
    pillMesa.textContent = m;
    pillEstado.textContent = 'esperando ticketâ€¦';
    items.forEach(i=>{ i.total = 0; i.selected = 0; updateLineMeta(i); });
    list.style.opacity = .6; list.style.pointerEvents = 'none';
    mesaTotalEl.textContent = 'â€”';
    refreshUI();
  });

  // + / -
  list.addEventListener('click',(e)=>{
    const act = e.target.dataset.act; if(!act) return;
    const li = e.target.closest('li');
    const obj = items.find(x=>x.el===li); if(!obj) return;
    if (act==='+'){ if (obj.selected < obj.total) obj.selected++; }
    if (act==='-'){ obj.selected = Math.max(0, obj.selected - 1); }
    updateLineMeta(obj);
    refreshUI();
  });

  // Confirmar pago (con nombre + mesa)
  document.querySelectorAll('.opt').forEach(o=>{
    o.addEventListener('click', ()=>{
      const method = o.dataset.method || 'Efectivo';
      const itemsSel = items.filter(i=>i.selected>0).map(i=>({name:i.name, qty:i.selected, price:i.price}));
      const total = itemsSel.reduce((s,i)=>s + i.qty*i.price, 0);
      const mesaSelEl = document.getElementById('mesaSelect');
      const mesa = mesaSelEl ? mesaSelEl.value : "6";
      const customerName = (nameInput.value || '').trim();
      // usamos code para mostrar el nombre en Camarero
      const code = (customerName ? customerName : 'Parcial') + ' â€¢ ' + Math.random().toString(36).slice(2,6).toUpperCase();

      bus.post({
        type:'partial_confirmed',
        mesa,
        name:'Parcial',
        method,
        amount: fmt(total),
        items: itemsSel,
        code
      });

      // reset selecciÃ³n (mantenemos nombre)
      items.forEach(i=>{ i.selected=0; updateLineMeta(i); });
      refreshUI();
    });
  });
  </script>
</body>
</html>
