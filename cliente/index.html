<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PagoYo â€” Vista Cliente</title>
  <style>
    :root { --teal:#0F766E; --orange:#E67E22; --bg:#F4F6F8; --ink:#111; --muted:#667085; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Arial,sans-serif;background:var(--bg);color:var(--ink);}
    header{background:var(--teal);color:#fff;padding:12px 14px}
    header .bar{max-width:820px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:8px}
    header .title{font-weight:800}
    header .meta{opacity:.95;font-weight:600}
    main{max-width:820px;margin:auto;padding:18px}
    .panel{display:grid;gap:10px;margin-bottom:12px}
    .banner{background:#f0fdfa;border:1px solid #99f6e4;color:#065f46;padding:10px 12px;border-radius:12px;font-weight:700}
    .totals{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .card{background:#fff;border-radius:12px;padding:12px;box-shadow:0 1px 4px rgba(0,0,0,.06);border:1px solid rgba(15,118,110,.1)}
    .label{font-size:12px;color:#555}
    .value{font-size:18px;font-weight:800;color:#0F766E}
    .hint{font-size:13px;color:var(--muted)}
    .list{list-style:none;margin:0;padding:0;display:grid;gap:10px}
    .row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
    .name{font-weight:700}
    .metaLine{font-size:12px;color:#555}
    .controls{display:flex;align-items:center;gap:8px}
    .pill{background:#f9fafb;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-size:12px;color:#444}
    .btnQty{width:32px;height:32px;border:none;border-radius:10px;background:#eef2f6;font-weight:800;cursor:pointer}
    .btnQty:hover{background:#e3e8ef}
    .qty{min-width:22px;text-align:center;font-weight:800}
    .lineTotal{min-width:82px;text-align:right;font-weight:800;color:#0F766E}
    .summary{display:flex;justify-content:space-between;align-items:center;background:#fff;border-radius:12px;padding:12px;border:1px solid rgba(15,118,110,.1);margin-top:10px}
    .summary strong{color:#0F766E}
    .btnMain{margin-top:14px;display:block;width:100%;background:var(--orange);color:#fff;font-weight:700;padding:14px;border:none;border-radius:12px;font-size:16px;cursor:pointer}
    .btnMain:disabled{background:#f1a361;cursor:not-allowed}
    .done{display:none;margin-top:12px;padding:12px;background:#ecfdf5;border:1px solid #86efac;border-radius:12px}
    .small{color:#444;font-size:14px;margin-top:6px}
    .ref{font-weight:800;color:#0F766E}
    footer{text-align:center;margin-top:16px}
    a{color:#0F766E;text-decoration:none;font-weight:600}
    /* Modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:18px}
    .modal{width:min(520px,92vw);background:#fff;border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.25);padding:18px;border:1px solid rgba(15,118,110,.15)}
    .modal h3{margin:0 0 10px;color:#0F766E}
    .options{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .opt{border:1.5px solid #e5e7eb;border-radius:12px;padding:12px;text-align:center;font-weight:700;cursor:pointer;background:#fafafa}
    .opt:hover{border-color:#0F766E}
    .opt.cash{background:#fff8ee}
    .opt.card{background:#eff6ff}
    .close{margin-top:12px;display:block;width:100%;background:#111;color:#fff;border:none;border-radius:10px;padding:10px;cursor:pointer}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <span class="title">Mesa 6 â€” Elige quÃ© pagar</span>
      <span class="meta" id="mesaTotal">Total mesa: â€”</span>
    </div>
  </header>

  <main>
    <!-- Panel de estado visual -->
    <div class="panel">
      <div class="banner">Selecciona quÃ© quieres pagar. Las unidades que elijas se descuentan del total disponible.</div>
      <div class="totals">
        <div class="card">
          <div class="label">Total disponible (unidades)</div>
          <div id="unitsLeft" class="value">â€”</div>
          <div class="hint">Se reduce al seleccionar</div>
        </div>
        <div class="card">
          <div class="label">Tu selecciÃ³n (â‚¬)</div>
          <div id="myAmount" class="value">0,00 â‚¬</div>
          <div class="hint">Suma de lo que has marcado</div>
        </div>
        <div class="card">
          <div class="label">QuedarÃ¡ por pagar</div>
          <div id="remainingAmount" class="value">â€”</div>
          <div class="hint">Solo informativo en esta demo</div>
        </div>
      </div>
    </div>

    <!-- Lista de consumiciones -->
    <ul id="itemsList" class="list">
      <!-- Cada li lleva data-total (unidades mesa), data-price y data-name -->
      <li data-total="3" data-price="9.50" data-name="RaciÃ³n Calamares" class="row">
        <div>
          <div class="name">RaciÃ³n Calamares <span class="pill">9,50 â‚¬</span></div>
          <div class="metaLine"><span class="leftLine">Quedan <strong>3</strong> de 3</span></div>
        </div>
        <div class="controls">
          <button class="btnQty" data-act="-">âˆ’</button>
          <span class="qty">0</span>
          <button class="btnQty" data-act="+">+</button>
          <div class="lineTotal">0,00 â‚¬</div>
        </div>
      </li>

      <li data-total="6" data-price="2.20" data-name="Refresco" class="row">
        <div>
          <div class="name">Refresco <span class="pill">2,20 â‚¬</span></div>
          <div class="metaLine"><span class="leftLine">Quedan <strong>6</strong> de 6</span></div>
        </div>
        <div class="controls">
          <button class="btnQty" data-act="-">âˆ’</button>
          <span class="qty">0</span>
          <button class="btnQty" data-act="+">+</button>
          <div class="lineTotal">0,00 â‚¬</div>
        </div>
      </li>

      <li data-total="2" data-price="6.00" data-name="RaciÃ³n Patatas" class="row">
        <div>
          <div class="name">RaciÃ³n Patatas <span class="pill">6,00 â‚¬</span></div>
          <div class="metaLine"><span class="leftLine">Quedan <strong>2</strong> de 2</span></div>
        </div>
        <div class="controls">
          <button class="btnQty" data-act="-">âˆ’</button>
          <span class="qty">0</span>
          <button class="btnQty" data-act="+">+</button>
          <div class="lineTotal">0,00 â‚¬</div>
        </div>
      </li>

      <li data-total="4" data-price="1.80" data-name="CaÃ±a" class="row">
        <div>
          <div class="name">CaÃ±a <span class="pill">1,80 â‚¬</span></div>
          <div class="metaLine"><span class="leftLine">Quedan <strong>4</strong> de 4</span></div>
        </div>
        <div class="controls">
          <button class="btnQty" data-act="-">âˆ’</button>
          <span class="qty">0</span>
          <button class="btnQty" data-act="+">+</button>
          <div class="lineTotal">0,00 â‚¬</div>
        </div>
      </li>

      <li data-total="2" data-price="4.50" data-name="Tarta de Queso" class="row">
        <div>
          <div class="name">Tarta de Queso <span class="pill">4,50 â‚¬</span></div>
          <div class="metaLine"><span class="leftLine">Quedan <strong>2</strong> de 2</span></div>
        </div>
        <div class="controls">
          <button class="btnQty" data-act="-">âˆ’</button>
          <span class="qty">0</span>
          <button class="btnQty" data-act="+">+</button>
          <div class="lineTotal">0,00 â‚¬</div>
        </div>
      </li>
    </ul>

    <!-- Resumen y CTA -->
    <div class="summary">
      <div class="hint">Selecciona unidades y pulsa confirmar</div>
      <div><strong id="myTotal">0,00 â‚¬</strong></div>
    </div>
    <button id="confirmBtn" class="btnMain" disabled>Confirmar y pagar</button>

    <!-- Confirmado -->
    <div id="doneBox" class="done">
      âœ” Tu parte estÃ¡ lista. MÃ©todo: <span id="methodTxt" class="ref">â€”</span><br/>
      <span class="small">Nombre: <span id="refCode" class="ref"></span></span>
    </div>

    <footer><p><a href="../">â¬… Volver al inicio</a></p></footer>
  </main>

  <!-- Modal -->
  <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <h3>Selecciona mÃ©todo de pago</h3>
      <div class="options">
        <div class="opt cash" data-method="Efectivo">ðŸ’µ Efectivo</div>
        <div class="opt card" data-method="Tarjeta">ðŸ’³ Tarjeta</div>
      </div>
      <div style="margin-top:10px">
        <label for="custName" style="display:block;font-weight:700;margin-bottom:6px;color:#0F766E">
          Tu nombre (para el camarero)
        </label>
        <input id="custName" type="text" placeholder="Ej. Juan"
          style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px" />
      </div>
      <button id="closeBtn" class="close">Cancelar</button>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const $$ = s => [...document.querySelectorAll(s)];
    const list = $("#itemsList");
    const mesaTotalEl = $("#mesaTotal");
    const unitsLeftEl = $("#unitsLeft");
    const myAmountEl = $("#myAmount");
    const remainingAmountEl = $("#remainingAmount");
    const myTotalEl = $("#myTotal");
    const confirmBtn = $("#confirmBtn");
    const overlay = $("#overlay");
    const closeBtn = $("#closeBtn");
    const doneBox = $("#doneBox");
    const methodTxt = $("#methodTxt");
    const refCode = $("#refCode");

    const fmt = n => n.toFixed(2).replace(".", ",") + " â‚¬";

    // Estado base (lo que trae el TPV para la mesa)
    const items = $$("#itemsList > li").map(li => ({
      el: li,
      name: li.dataset.name,
      price: parseFloat(li.dataset.price),
      total: parseInt(li.dataset.total,10),
      selected: 0
    }));

    // Calcular totales de mesa (â‚¬ y unidades)
    function mesaImporteTotal(){
      return items.reduce((acc,i)=> acc + i.price * i.total, 0);
    }
    function mesaUnidadesTotal(){
      return items.reduce((acc,i)=> acc + i.total, 0);
    }

    function mesaUnidadesRestantes(){
      return items.reduce((acc,i)=> acc + (i.total - i.selected), 0);
    }
    function mesaImporteRestante(){
      return items.reduce((acc,i)=> acc + (i.total - i.selected) * i.price, 0);
    }
    function miImporte(){
      return items.reduce((acc,i)=> acc + i.selected * i.price, 0);
    }

    // Pintar cabecera y panel
    function refreshUI(){
      mesaTotalEl.textContent = "Total mesa: " + fmt(mesaImporteTotal());
      unitsLeftEl.textContent = mesaUnidadesRestantes() + " / " + mesaUnidadesTotal();
      myAmountEl.textContent = fmt(miImporte());
      remainingAmountEl.textContent = fmt(mesaImporteRestante());
      myTotalEl.textContent = fmt(miImporte());
      confirmBtn.disabled = miImporte() <= 0;

      // Por cada lÃ­nea, actualizar â€œQuedanâ€ y total de lÃ­nea
      items.forEach(i=>{
        const left = i.total - i.selected;
        i.el.querySelector(".leftLine strong").textContent = left;
        i.el.querySelector(".qty").textContent = i.selected;
        i.el.querySelector(".lineTotal").textContent = fmt(i.selected * i.price);
      });
    }

    // Controles +/-
    list.addEventListener("click", (e)=>{
      const act = e.target.dataset.act;
      if(!act) return;
      const li = e.target.closest("li");
      const it = items.find(x=>x.el===li);
      if(!it) return;
      if(act === "+"){
        // no permitir pasar de lo disponible
        if(it.selected < it.total) it.selected++;
      }else{
        if(it.selected > 0) it.selected--;
      }
      refreshUI();
    });

    // Inicial
    refreshUI();

    // Confirmar â†’ abrir modal
    confirmBtn.addEventListener("click", ()=>{
      overlay.style.display = "flex";
      overlay.setAttribute("aria-hidden","false");
    });
    closeBtn.addEventListener("click", ()=>{
      overlay.style.display = "none";
      overlay.setAttribute("aria-hidden","true");
    });
    overlay.addEventListener("click", (e)=>{ if(e.target===overlay) closeBtn.click(); });

    // Canal a Camarero
    const ch = new BroadcastChannel('pagoyo_demo');

    // Elegir mÃ©todo y enviar
    $$(".opt").forEach(opt=>{
      opt.addEventListener("click", ()=>{
        const method = opt.dataset.method;
        const name = ($("#custName").value || "Cliente").trim();

        // Construir string de items seleccionados
        const itemsSel = items
          .filter(i=> i.selected>0)
          .map(i=> `${i.selected}Ã— ${i.name}`)
          .join(" Â· ");

        // Importe
        const total = miImporte();

        // Resumen local
        methodTxt.textContent = method;
        refCode.textContent = name;
        doneBox.style.display = "block";
        confirmBtn.textContent = "Parte confirmada";
        confirmBtn.disabled = true;
        closeBtn.click();

        // Enviar al Panel Camarero
        ch.postMessage({
          type: 'partial_confirmed',
          name,
          method,
          amount: fmt(total).replace(/\s/g,''), // "18,50 â‚¬"
          items: itemsSel,
          code: "M6-" + Math.random().toString(36).slice(2,6).toUpperCase()
        });

        // Opcional: bloquear mÃ¡s cambios (demo)
        list.style.opacity = .6;
        list.style.pointerEvents = "none";
      });
    });
  </script>
</body>
</html>

