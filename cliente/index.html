<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PagoYo — Cliente (Demo)</title>
  <style>
    :root{--teal:#0F766E;--orange:#E67E22}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,Arial,sans-serif;color:#111;background:#fff}
    header{background:var(--teal);color:#fff;padding:12px}
    header .bar{max-width:920px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
    main{max-width:920px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:14px;box-shadow:0 1px 4px rgba(0,0,0,.06)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:8px 0}
    .pill{background:#F4F6F8;border:1px solid #e5e7eb;border-radius:20px;padding:6px 10px;font-size:12px;color:#0F766E}
    .btn{background:var(--teal);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn[disabled], .method.disabled{opacity:.4;pointer-events:none}
    .method.active{outline:2px solid #0F766E}
    ul{list-style:none;padding:0;margin:0}
    li{padding:10px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .controls{display:flex;align-items:center;gap:8px}
    .qty{min-width:24px;text-align:center;display:inline-block}
    .right{margin-left:auto}
    input[type="text"]{border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px}
    .flash{animation:flash .6s ease-out}
    @keyframes flash{from{box-shadow:0 0 0 rgba(15,118,110,0)}to{box-shadow:0 0 0 10px rgba(15,118,110,.12)}}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#111;color:#fff;padding:10px 14px;border-radius:10px}
  </style>
</head>
<body>
  <header><div class="bar"><strong>PagoYo — Cliente</strong><a href="../" style="color:#fff;text-decoration:none">⬅ Inicio</a></div></header>

  <div style="text-align:center;background:#F4F6F8;padding:10px 0;">
    <label for="mesaSelect" style="font-weight:700;color:#0F766E;">Mesa:</label>
    <select id="mesaSelect" style="padding:6px 10px;border-radius:10px;border:1px solid #ccc;">
      <option value="6" selected>Mesa 6</option>
      <option value="5">Mesa 5</option>
      <option value="4">Mesa 4</option>
    </select>
  </div>
  <div id="syncPill" style="text-align:center;font-size:13px;margin:6px 0;color:#0F766E">
    Mesa <strong id="pillMesa">6</strong> · <span id="pillEstado">esperando ticket…</span>
  </div>

  <!-- Pantalla inicial -->
  <section id="introCard" class="card" style="max-width:920px;margin:12px auto;">
    <div style="text-align:center;display:grid;gap:12px">
      <div style="font-size:18px;font-weight:800;color:#0F766E">¿Cómo quieres pagar?</div>
      <div style="color:#555">Elige la forma de repartir tu parte del ticket.</div>
      <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <button id="btnModeSplit" class="btn" type="button" style="background:#111">Pagar a medias con todos</button>
        <button id="btnModeMine" class="btn" type="button">Pagar solo lo mío</button>
      </div>
    </div>
  </section>

  <!-- Modo “Pagar a medias” -->
<section id="splitCard" class="card" style="max-width:920px;margin:12px auto;display:none">
  <div class="row" style="gap:8px">
    <button id="btnBackToIntro" class="btn" type="button" style="background:#111">← Volver</button>
    <div class="right" style="font-weight:700;color:#0F766E">Pagar a medias con todos</div>
  </div>

  <div class="row">
    <div><strong>Total mesa:</strong></div>
    <div id="splitMesaTotal">—</div>
  </div>

  <div class="row">
    <div>Comensales</div>
    <div class="controls">
      <button id="dinersMinus" class="btn" type="button">−</button>
      <span id="dinersVal" class="qty">2</span>
      <button id="dinersPlus" class="btn" type="button">+</button>
    </div>
  </div>

  <div class="row">
    <div>Importe por persona</div>
    <div id="perPerson" style="font-weight:800">0,00 €</div>
  </div>

  <div class="row" style="flex-wrap:wrap">
    <div style="display:flex;align-items:center;gap:10px">
      <div style="min-width:90px">💶 Efectivo</div>
      <div class="controls">
        <button id="cashMinus" class="btn" type="button">−</button>
        <span id="cashVal" class="qty">0</span>
        <button id="cashPlus" class="btn" type="button">+</button>
      </div>
    </div>
    <div class="right" style="display:flex;align-items:center;gap:10px">
      <div style="min-width:90px">💳 Tarjeta</div>
      <div class="controls">
        <button id="cardMinus" class="btn" type="button">−</button>
        <span id="cardVal" class="qty">2</span>
        <button id="cardPlus" class="btn" type="button">+</button>
      </div>
    </div>
  </div>

  <div style="font-size:12px;color:#555;margin:6px 0">
    La suma de 💶 y 💳 debe ser igual a los comensales.
  </div>

  <div class="row">
    <div></div>
    <button id="confirmSplitBtn" class="btn" type="button" disabled>Confirmar pago a medias</button>
  </div>
</section>


  <!-- Modo “Pagar lo mío” -->
  <main id="main" style="display:none">
    <section class="card">
      <div class="row"><strong>Total mesa:</strong> <span id="mesaTotal">—</span></div>
      <ul id="itemsList"></ul>
      <div class="row" style="flex-wrap:wrap;gap:12px">
        <div><span>Mi importe:</span> <strong id="myTotal">0,00 €</strong></div>
        <div class="right" style="display:flex;align-items:center;gap:8px">
          <input id="customerName" type="text" placeholder="Tu nombre (obligatorio)" />
          <button class="method btn" data-method="Efectivo" type="button">💶 Efectivo</button>
          <button class="method btn" data-method="Tarjeta"  type="button">💳 Tarjeta</button>
          <button id="confirmBtn" class="btn" disabled>Confirmar pago</button>
        </div>
      </div>
    </section>
  </main>

  <script>
  // ===== Bus robusto (BroadcastChannel con fallback a localStorage) =====
  function makeBus(name, onMessage){
    const HAS_BC = 'BroadcastChannel' in window;
    if (HAS_BC){
      const bc = new BroadcastChannel(name);
      if (onMessage) bc.onmessage = (e)=>onMessage(e.data||{});
      return { post:(d)=>bc.postMessage(d), close:()=>bc.close() };
    } else {
      if (onMessage){
        window.addEventListener('storage',(e)=>{
          if (e.key===name && e.newValue){ try{ onMessage(JSON.parse(e.newValue)); }catch(_){ } }
        });
      }
      return { post:(d)=>{ try{ localStorage.setItem(name, JSON.stringify(d)); }catch(_){ } }, close:()=>{} };
    }
  }
  const bus = makeBus('pagoyo_demo');

  // ===== Utilidades y refs
  const fmt = (n)=> (n||0).toFixed(2).replace('.',',') + ' €';
  const euroToNum = (s)=> parseFloat((s||'0').toString().replace(/\./g,'').replace(',','.').replace(/[^\d.]/g,''))||0;

  const list = document.getElementById('itemsList');
  const mesaTotalEl = document.getElementById('mesaTotal');
  const myTotalEl = document.getElementById('myTotal');
  const confirmBtn = document.getElementById('confirmBtn');
  const nameInput = document.getElementById('customerName');

  const pillMesa = document.getElementById('pillMesa');
  const pillEstado = document.getElementById('pillEstado');

  // Portada / modo
  const mainEl   = document.getElementById('main');
  const introEl  = document.getElementById('introCard');
  const btnSplit = document.getElementById('btnModeSplit');
  const btnMine  = document.getElementById('btnModeMine');

  function showIntro(){ introEl.style.display='block'; mainEl.style.display='none'; }
  function showMine(){  introEl.style.display='none';  mainEl.style.display='block'; syncFlowState(); }

  if (btnMine)  btnMine.addEventListener('click', showMine);
  if (btnSplit) btnSplit.addEventListener('click', ()=>{ alert('Activamos “Pagar a medias” en el siguiente paso. Usa “Pagar solo lo mío” para la demo.'); });

  // Estructura de línea
  const items = []; // [{ el, name, price, total, selected }]

  function ensureLine(name, price){
    let li = [...document.querySelectorAll('#itemsList > li')].find(x=>x.dataset.name===name);
    if (!li){
      li = document.createElement('li');
      li.dataset.name = name;
      li.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:4px">
          <div><strong>${name}</strong>
            <span class="pill" style="margin-left:6px">${price.toFixed(2).replace('.',',')} €</span>
          </div>
          <div class="meta" style="font-size:12px;color:#555">Quedan <strong class="rem">0</strong> de <strong class="tot">0</strong></div>
        </div>
        <div class="controls">
          <button class="optQty" data-act="-">−</button>
          <span class="qty">0</span>
          <button class="optQty" data-act="+">+</button>
          <div class="lineTotal right">0,00 €</div>
        </div>`;
      list.appendChild(li);
      items.push({ el: li, name, price, total: 0, selected: 0 });
    }
    return li;
  }

  function updateLineMeta(obj){
    const rem = Math.max(0, (obj.total||0) - (obj.selected||0));
    obj.el.querySelector('.rem').textContent = rem;
    obj.el.querySelector('.tot').textContent = obj.total || 0;
    obj.el.querySelector('.qty').textContent = obj.selected || 0;
    obj.el.querySelector('.lineTotal').textContent = fmt((obj.selected||0) * obj.price);
  }

  function refreshUI(){
    let mt = 0;
    items.forEach(i=>{ mt += i.selected * i.price; });
    myTotalEl.textContent = fmt(mt);
    confirmBtn.disabled = mt <= 0;
    syncFlowState();
  }

  function currentAmount(){
    return (items||[]).reduce((s,i)=> s + (i.selected||0) * (i.price||0), 0);
  }
  let selectedMethod = null;
  function syncFlowState(){
    const nameOk = (nameInput.value||'').trim().length > 0;
    document.querySelectorAll('.method').forEach(b=>{
      if (nameOk){ b.classList.remove('disabled'); b.removeAttribute('disabled'); }
      else       { b.classList.add('disabled');    b.setAttribute('disabled',''); }
    });
    confirmBtn.disabled = !(nameOk && selectedMethod && currentAmount() > 0);
  }
  nameInput.addEventListener('input', syncFlowState);

  // Escuchar TPV (robusto). No entrar solo; mostrar “ticket listo”.
  makeBus('pagoyo_demo', (d)=>{
    try{
      const mesaSel = (document.getElementById('mesaSelect')?.value || '6').toString().replace(/\D/g,'');
      const msgMesa = (d.mesa || '6').toString().replace(/\D/g,'');
      if (msgMesa && mesaSel && msgMesa !== mesaSel) return;

      if (d.type === 'tpv_ticket_update') {
        applyTPVUpdate(d);
        pillEstado.textContent = 'ticket listo';
        // Mantener portada hasta que pulse “Pagar solo lo mío”
      }
      if (d.type === 'tpv_ticket_close'){
        list.style.opacity = .6; list.style.pointerEvents = 'none';
        pillEstado.textContent = 'ticket cerrado'; confirmBtn.disabled = true;
        const t=document.createElement('div');t.className='toast';t.textContent='Ticket cerrado desde TPV';document.body.appendChild(t);
        setTimeout(()=>{t.style.transition='opacity .25s, transform .25s';t.style.opacity=0;t.style.transform='translateY(-8px)';},1500);
        setTimeout(()=>t.remove(),1800);
      }
    }catch(err){ console.error('Cliente onmessage', err); }
  });

  function applyTPVUpdate(payload){
    try{
      // Reinicia totales/selección y asegura líneas
      items.forEach(i=>{ i.total = 0; i.selected = 0; updateLineMeta(i); });
      (payload.items||[]).forEach(it=>{
        const price = parseFloat(it.price);
        const li = ensureLine(it.name, price);
        const obj = items.find(x=>x.el===li);
        obj.total = parseInt(it.qty||0,10);
        obj.selected = 0;
        updateLineMeta(obj);
      });

      mesaTotalEl.textContent = payload.total || '—';
      list.style.opacity = 1; list.style.pointerEvents = 'auto';
      list.classList.add('flash'); setTimeout(()=>list.classList.remove('flash'),600);
      refreshUI();
    }catch(err){ console.error('applyTPVUpdate error:', err); }
  }

  // Inicial en blanco
  items.forEach(i=>{ i.total = 0; i.selected = 0; updateLineMeta(i); });
  list.style.opacity = .6; list.style.pointerEvents = 'none';
  mesaTotalEl.textContent = '—';
  refreshUI();

  // Cambios de mesa
  document.getElementById('mesaSelect').addEventListener('change', ()=>{
    const m = document.getElementById('mesaSelect').value;
    pillMesa.textContent = m; pillEstado.textContent = 'esperando ticket…';
    items.forEach(i=>{ i.total = 0; i.selected = 0; updateLineMeta(i); });
    list.style.opacity = .6; list.style.pointerEvents = 'none';
    mesaTotalEl.textContent = '—';
    refreshUI();
  });

  // + / -
  list.addEventListener('click',(e)=>{
    const act = e.target.dataset.act; if(!act) return;
    const li = e.target.closest('li');
    const obj = items.find(x=>x.el===li); if(!obj) return;
    if (act==='+'){ if (obj.selected < obj.total) obj.selected++; }
    if (act==='-'){ obj.selected = Math.max(0, obj.selected - 1); }
    updateLineMeta(obj);
    refreshUI();
  });

  // Seleccionar método
  document.querySelectorAll('.method').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if ((nameInput.value||'').trim().length === 0){
        alert('Escribe tu nombre para continuar.');
        nameInput.focus();
        return;
      }
      selectedMethod = btn.dataset.method;
      document.querySelectorAll('.method').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      syncFlowState();
    });
  });

  // Confirmar pago
  confirmBtn.addEventListener('click', ()=>{
    const nameOk = (nameInput.value||'').trim().length > 0;
    if (!nameOk){ alert('Nombre obligatorio.'); nameInput.focus(); return; }
    if (!selectedMethod){ alert('Selecciona método: 💶 Efectivo o 💳 Tarjeta'); return; }

    const itemsSel = items.filter(i=>i.selected>0).map(i=>({name:i.name, qty:i.selected, price:i.price}));
    const total = itemsSel.reduce((s,i)=>s + i.qty*i.price, 0);
    if (total <= 0){ alert('Selecciona al menos una consumición.'); return; }

    const mesaSelEl = document.getElementById('mesaSelect');
    const mesa = mesaSelEl ? mesaSelEl.value : "6";
    const customerName = (nameInput.value||'').trim();
    const code = (customerName ? customerName : 'Parcial') + ' • ' + Math.random().toString(36).slice(2,6).toUpperCase();

    bus.post({
      type:'partial_confirmed',
      mesa,
      name:'Parcial',
      method: selectedMethod,
      amount: fmt(total),
      items: itemsSel,
      code
    });

    // reset selección (mantenemos nombre y método activo)
    items.forEach(i=>{ i.selected=0; updateLineMeta(i); });
    refreshUI();
  });

  // Mostrar portada al cargar
  showIntro();
  syncFlowState();
  </script>
</body>
</html>
