<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PagoYo — Panel Camarero</title>
  <style>
    :root{--teal:#0F766E;--orange:#E67E22;--bg:#F4F6F8;--ok:#16a34a;--warn:#ef4444}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,Arial,sans-serif;background:var(--bg);color:#111}
    header{background:var(--teal);color:#fff;padding:12px}
    header .bar{max-width:900px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:8px}
    header .btn{background:#111;color:#fff;border:none;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700}
    main{max-width:900px;margin:auto;padding:18px}
    .grid{display:grid;gap:12px}
    .totals{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 1px 4px rgba(0,0,0,.06);border:1px solid rgba(15,118,110,.1)}
    .label{font-size:13px;color:#555}
    .value{font-size:22px;font-weight:800;color:#0F766E}
    .list{display:grid;gap:10px;margin-top:6px}
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between;border:1px solid #e5e7eb;border-radius:12px;padding:12px;background:#fff}
    .left{display:flex;flex-direction:column;gap:4px}
    .id{font-weight:700}
    .items{font-size:13px;color:#555}
    .badge{border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700}
    .card-badge{background:#eefcf9;color:#0F766E;border:1px solid rgba(15,118,110,.25)}
    .cash{background:#fff7ed;color:#b45309;border:1px solid #fdba74}
    .cardm{background:#eff6ff;color:#1d4ed8;border:1px solid #93c5fd}
    .paid{background:#ecfdf5;color:#16a34a;border:1px solid #86efac}
    .btn{border:none;background:var(--teal);color:#fff;font-weight:700;padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn:disabled{background:#ddd;color:#666;cursor:default}
    .flash{animation:flash .6s ease-out}
    @keyframes flash{from{box-shadow:0 0 0 rgba(15,118,110,0)}to{box-shadow:0 0 0 8px rgba(15,118,110,.12)}}
    footer{text-align:center;margin-top:14px}
    a{color:#0F766E;text-decoration:none;font-weight:600}
    @media (max-width:720px){.totals{grid-template-columns:1fr}}
    .tiny{font-size:12px;opacity:.7}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <span>Mesa 6 — Panel Camarero</span>
      <div>
        <a id="demoAdd" class="tiny" href="#" style="display:none;margin-right:8px;color:#fff;text-decoration:underline">➕ parcial demo</a>
        <button id="resetBtn" class="btn" style="background:#111">Reset demo</button>
      </div>
    </div>
  </header>

  <main class="grid">
    <section class="totals">
      <div class="card"><div class="label">Total TPV</div><div id="tpvTotal" class="value">69,90 €</div></div>
      <div class="card"><div class="label">Total cobrado</div><div id="paidTotal" class="value">0,00 €</div></div>
      <div class="card"><div class="label">Total pendiente cobrar</div><div id="pendingTotal" class="value" style="color:#ef4444">69,90 €</div></div>
    </section>

    <div id="closeBanner" style="display:none;background:#ecfdf5;border:1px solid #86efac;color:#166534;
      padding:12px;border-radius:12px;text-align:center;font-weight:700;font-size:17px;">
      ✅ Mesa lista para cerrar
    </div>

    <section id="paymentsCard" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0;color:#0F766E">Pagos</h3>
        <span id="pendingCount" class="badge card-badge">Pendientes: 0</span>
      </div>
      <div id="paymentsList" class="list"></div>
    </section>

    <footer><p><a href="../">⬅ Volver al inicio</a></p></footer>
  </main>

  <script>
    const euroToNum = (s) => parseFloat(s.replace(/\./g,'').replace(',', '.').replace(/[^\d.]/g,'')) || 0;
    const numToEuro = (n) => n.toFixed(2).replace('.', ',') + ' €';

    const paymentsCard  = document.getElementById('paymentsCard');
    const paymentsList  = document.getElementById('paymentsList');
    const pendingCount  = document.getElementById('pendingCount');
    const tpvEl         = document.getElementById('tpvTotal');
    const paidEl        = document.getElementById('paidTotal');
    const pendingEl     = document.getElementById('pendingTotal');
    const resetBtn      = document.getElementById('resetBtn');
    const banner        = document.getElementById('closeBanner');
    const demoAdd       = document.getElementById('demoAdd');

    const initialTPV  = euroToNum(tpvEl.textContent);
    let totalTPV      = initialTPV;
    let totalPaid     = 0;
    let pending       = 0;

    function refreshTotals() {
      paidEl.textContent = numToEuro(totalPaid);
      const totalPending = Math.max(0, totalTPV - totalPaid);
      pendingEl.textContent  = numToEuro(totalPending);
      pendingEl.style.color  = totalPending > 0 ? '#ef4444' : '#16a34a';
      banner.style.display   = totalPending === 0 ? 'block' : 'none';
      pendingCount.textContent = 'Pendientes: ' + pending;
    }
    refreshTotals();

    function addPendingRow({code, amount, items, method, name}) {
      const badgeClass = method === 'Efectivo' ? 'cash' : 'cardm';
      const who = name ? ` de ${name}` : '';
      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML = `
        <div class="left">
          <span class="id">Parcial${who} #${code} • ${amount}</span>
          <span class="items">${items || ''}</span>
        </div>
        <span class="badge ${badgeClass}">${method}</span>
        <button class="btn">Marcar cobrado</button>
      `;
      paymentsList.prepend(row);
      pending++;
      refreshTotals();
      attachButton(row.querySelector(".btn"));
      // Destello + scroll
      paymentsCard.classList.add('flash');
      setTimeout(()=>paymentsCard.classList.remove('flash'), 600);
      row.scrollIntoView({behavior:'smooth', block:'start'});
    }

    function attachButton(btn) {
      btn.addEventListener("click", () => {
        const idLine = btn.parentElement.querySelector('.id').textContent;
        const m = idLine.match(/•\s*([\d.,]+)\s*€/);
        const amountNum = m ? euroToNum(m[1] + ' €') : 0;

        btn.disabled = true;
        btn.textContent = "Cobrado";
        btn.previousElementSibling.className = "badge paid";
        btn.previousElementSibling.textContent = "Cobrado";

        pending = Math.max(0, pending - 1);
        totalPaid = Math.min(totalTPV, totalPaid + amountNum);
        refreshTotals();
      });
    }

   // Canal Cliente/TPV → Camarero
const ch = new BroadcastChannel('pagoyo_demo');
ch.onmessage = (e) => {
  const data = e.data || {};

  if (data.type === 'partial_confirmed') {
    addPendingRow(data);
  }

  if (data.type === 'tpv_ticket_update') {
    // Actualiza Total TPV desde el TPV simulado y resetea cobros/pendientes
    tpvEl.textContent = data.total || numToEuro(0);
    totalTPV  = euroToNum(tpvEl.textContent);
    totalPaid = 0;
    pending   = 0;
    paymentsList.innerHTML = '';
    refreshTotals();
  }

  if (data.type === 'tpv_ticket_close') {
    // Opcional: muestra banner de cierre
    if (banner) banner.style.display = 'block';
  }
};


    // Reset
   resetBtn.addEventListener('click', () => {
  // Usa el TPV que esté ahora en pantalla como base
  totalTPV  = euroToNum(tpvEl.textContent);
  totalPaid = 0;
  paymentsList.innerHTML = '';
  pending   = 0;
  refreshTotals();
});


    // Atajo de demo (activar con ?demo=1)
    if (location.search.includes('demo=1')) {
      demoAdd.style.display = 'inline';
      demoAdd.addEventListener('click', (ev)=>{
        ev.preventDefault();
        addPendingRow({
          code: 'DEMO',
          amount: '12,30 €',
          items: '1× Caña · 1× Refresco · 1× Tarta de Queso',
          method: Math.random()>.5?'Tarjeta':'Efectivo',
          name: 'Demo'
        });
      });
    }
  </script>
</body>
</html>

