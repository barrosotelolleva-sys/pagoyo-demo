<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PagoYo — Panel Camarero</title>
  <style>
    :root{--teal:#0F766E;--orange:#E67E22;--bg:#F4F6F8;--ok:#16a34a;--warn:#ef4444}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,Arial,sans-serif;background:var(--bg);color:#111}
    header{background:var(--teal);color:#fff;padding:12px}
    header .bar{max-width:900px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:8px}
    header .btn{background:#111;color:#fff;border:none;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700}
    main{max-width:900px;margin:auto;padding:18px}
    .grid{display:grid;gap:12px}
    .totals{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 1px 4px rgba(0,0,0,.06);border:1px solid rgba(15,118,110,.1)}
    .label{font-size:13px;color:#555}
    .value{font-size:22px;font-weight:800;color:#0F766E}
    .list{display:grid;gap:10px;margin-top:6px}
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between;border:1px solid #e5e7eb;border-radius:12px;padding:12px;background:#fff}
    .left{display:flex;flex-direction:column;gap:4px}
    .id{font-weight:700}
    .items{font-size:13px;color:#555}
    .badge{border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700}
    .card-badge{background:#eefcf9;color:#0F766E;border:1px solid rgba(15,118,110,.25)}
    .cash{background:#fff7ed;color:#b45309;border:1px solid #fdba74}
    .cardm{background:#eff6ff;color:#1d4ed8;border:1px solid #93c5fd}
    .paid{background:#ecfdf5;color:#16a34a;border:1px solid #86efac}
    .btn{border:none;background:var(--teal);color:#fff;font-weight:700;padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn:disabled{background:#ddd;color:#666;cursor:default}
    footer{text-align:center;margin-top:14px}
    a{color:#0F766E;text-decoration:none;font-weight:600}
    @media (max-width:720px){.totals{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <span>Mesa 6 — Panel Camarero</span>
      <button id="resetBtn" class="btn" style="background:#111">Reset demo</button>
    </div>
  </header>

  <main class="grid">
    <!-- TOTALES (con IDs para actualizarlos) -->
    <div id="closeBanner" style="display:none;background:#ecfdf5;border:1px solid #86efac;color:#166534;
padding:12px;border-radius:12px;text-align:center;font-weight:700;font-size:17px;">
  ✅ Mesa lista para cerrar
</div>

 <section class="totals">
  <div class="card"><div class="label">Total TPV</div><div id="tpvTotal" class="value">69,90 €</div></div>
  <div class="card"><div class="label">Total cobrado</div><div id="assignedTotal" class="value">45,70 €</div></div>
  <div class="card"><div class="label">Total pendiente cobrar</div><div id="pendingTotal" class="value" style="color:#ef4444">24,20 €</div></div>
</section>
   

    <!-- LISTA PAGOS -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0;color:#0F766E">Pagos</h3>
        <span id="pendingCount" class="badge card-badge">Pendientes: 2</span>
      </div>
      <div id="paymentsList" class="list">
        <div class="row">
          <div class="left">
            <span class="id">Parcial #A1 • 18,50 €</span>
            <span class="items">1× Calamares · 2× Refresco</span>
          </div>
          <span class="badge cardm">Tarjeta</span>
          <button class="btn">Marcar cobrado</button>
        </div>

        <div class="row">
          <div class="left">
            <span class="id">Parcial #B2 • 27,20 €</span>
            <span class="items">1× Calamares · 1× Patatas · 2× Caña</span>
          </div>
          <span class="badge cash">Efectivo</span>
          <button class="btn">Marcar cobrado</button>
        </div>

        <div class="row">
          <div class="left">
            <span class="id">Parcial #C3 • 24,20 €</span>
            <span class="items">1× Calamares · 2× Refresco · 2× Tarta</span>
          </div>
          <span class="badge paid">Cobrado</span>
          <button class="btn" disabled>Cobrado</button>
        </div>
      </div>
    </section>

    <footer><p><a href="../">⬅ Volver al inicio</a></p></footer>
  </main>

  <script>
    // --- Utils € ↔ número
    const euroToNum = (s) =>
      parseFloat(s.replace(/\./g,'').replace(',', '.').replace(/[^\d.]/g,'')) || 0;
    const numToEuro = (n) => n.toFixed(2).replace('.', ',') + ' €';

    // --- Elementos
    const paymentsList  = document.getElementById('paymentsList');
    const pendingCount  = document.getElementById('pendingCount');
    const tpvEl         = document.getElementById('tpvTotal');
    const assignedEl    = document.getElementById('assignedTotal');
    const pendingEl     = document.getElementById('pendingTotal');
    const resetBtn      = document.getElementById('resetBtn');

    // --- Estados iniciales
    const initial = {
      tpv:      euroToNum(tpvEl.textContent),       // 69,90
      assigned: euroToNum(assignedEl.textContent),  // 45,70
      listHTML: document.getElementById('paymentsList').innerHTML
    };

    let totalTPV      = initial.tpv;
    let totalAssigned = initial.assigned;

    function refreshTotals() {
  assignedEl.textContent = numToEuro(totalAssigned);
  const totalPending = Math.max(0, totalTPV - totalAssigned);
  pendingEl.textContent  = numToEuro(totalPending);
  pendingEl.style.color  = totalPending > 0 ? '#ef4444' : '#16a34a';

  // Mostrar/ocultar aviso de mesa lista
  const banner = document.getElementById('closeBanner');
  banner.style.display = totalPending === 0 ? 'block' : 'none';
}

    // Contador pendientes inicial
    let pending = document.querySelectorAll('.row .btn:not([disabled])').length;
    pendingCount.textContent = 'Pendientes: ' + pending;
    refreshTotals();

    // --- Marcar cobrado: aquí sí cambian €
    function attachButton(btn) {
      btn.addEventListener("click", () => {
        const idLine = btn.parentElement.querySelector('.id').textContent;
        const m = idLine.match(/•\s*([\d.,]+)\s*€/);
        const amountNum = m ? euroToNum(m[1] + ' €') : 0;

        btn.disabled = true;
        btn.textContent = "Cobrado";
        btn.previousElementSibling.className = "badge paid";
        btn.previousElementSibling.textContent = "Cobrado";

        pending = Math.max(0, pending - 1);
        pendingCount.textContent = 'Pendientes: ' + pending;

        totalAssigned = Math.min(totalTPV, totalAssigned + amountNum);
        refreshTotals();
      });
    }
    document.querySelectorAll(".row .btn").forEach(attachButton);

    // --- Al confirmar cliente: solo añadir fila y subir contador (NO €)
   function addPendingRow({code, amount, items, method, name}) {
  const badgeClass = method === 'Efectivo' ? 'cash' : 'cardm';
  const who = name ? ` de ${name}` : '';
  const row = document.createElement('div');
  row.className = 'row';
  row.innerHTML = `
    <div class="left">
      <span class="id">Parcial${who} #${code} • ${amount}</span>
      <span class="items">${items}</span>
    </div>
    <span class="badge ${badgeClass}">${method}</span>
    <button class="btn">Marcar cobrado</button>
  `;
  paymentsList.prepend(row);
  pending++;
  pendingCount.textContent = 'Pendientes: ' + pending;
  attachButton(row.querySelector(".btn"));
}


    // --- Canal entre pestañas
    const ch = new BroadcastChannel('pagoyo_demo');
    ch.onmessage = (e) => {
      const data = e.data || {};
      if (data.type === 'partial_confirmed') addPendingRow(data);
    };

    // --- Reset demo
    resetBtn.addEventListener('click', () => {
      totalTPV = initial.tpv;
      totalAssigned = initial.assigned;
      document.getElementById('paymentsList').innerHTML = initial.listHTML;

      // Recontar y reenganchar
      pending = document.querySelectorAll('.row .btn:not([disabled])').length;
      pendingCount.textContent = 'Pendientes: ' + pending;
      document.querySelectorAll(".row .btn").forEach(attachButton);
      refreshTotals();
    });
  </script>
</body>
</html>

