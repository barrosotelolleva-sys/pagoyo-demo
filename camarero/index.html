<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PagoYo — Camarero (Demo)</title>
  <link rel="manifest" href="/pagoyo-demo/manifest.webmanifest">
<meta name="theme-color" content="#0F766E">
<link rel="icon" href="/pagoyo-demo/icons/pagoyo-192.png">

  <style>
    :root{--teal:#0F766E}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,Arial,sans-serif;color:#111;background:#fff}
    header{background:var(--teal);color:#fff;padding:12px}
    header .bar{max-width:920px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
    main{max-width:920px;margin:0 auto;padding:16px;display:grid;gap:12px}
    .cards{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:14px;box-shadow:0 1px 4px rgba(0,0,0,.06)}
    .value{font-size:22px;font-weight:800}
    .btn{background:var(--teal);color:#fff;border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
    .badge{background:#F4F6F8;border:1px solid #e5e7eb;border-radius:20px;padding:4px 8px;font-size:12px;color:#0F766E}
    table{width:100%;border-collapse:collapse;font-size:14px} th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    .flash{animation:flash .6s ease-out}@keyframes flash{from{box-shadow:0 0 0 rgba(15,118,110,0)}to{box-shadow:0 0 0 10px rgba(15,118,110,.12)}}
  </style>
</head>
  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/pagoyo-demo/sw.js').catch(console.error);
  }
</script>

<body>
  <header><div class="bar"><strong>PagoYo — Panel Camarero</strong><a href="../" style="color:#fff;text-decoration:none">⬅ Inicio</a></div></header>

  <div style="text-align:center;background:#F4F6F8;padding:10px 0;">
    <label for="mesaSelect" style="font-weight:700;color:#0F766E;">Mesa:</label>
    <select id="mesaSelect" style="padding:6px 10px;border-radius:10px;border:1px solid #ccc;">
      <option value="6" selected>Mesa 6</option>
      <option value="5">Mesa 5</option>
      <option value="4">Mesa 4</option>
    </select>
  </div>
  <div id="syncPill" style="text-align:center;font-size:13px;margin:6px 0;color:#0F766E">
    Mesa <strong id="pillMesa">6</strong> · <span id="pillEstado">esperando ticket…</span>
  </div>

  <main>
    <section class="cards">
      <div class="card"><div>Total TPV</div><div id="tpvTotal" class="value">0,00 €</div></div>
      <div class="card"><div>Total cobrado</div><div id="paidTotal" class="value">0,00 €</div></div>
      <div class="card"><div>Total pendiente cobrar</div><div id="pendingTotal" class="value" style="color:#ef4444">0,00 €</div></div>
    </section>

    <section class="card" id="paymentsCard">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h3 style="margin:0;color:#0F766E">Pagos</h3>
        <span id="banner" class="badge" style="display:none">Ticket cerrado</span>
      </div>
      <table>
        <thead><tr><th>Parcial</th><th>Detalle</th><th>Método</th><th>Importe</th><th></th></tr></thead>
        <tbody id="paymentsList"></tbody>
      </table>
    </section>
    <div><button id="resetBtn" class="btn">Reset demo</button></div>
  </main>

  <script>
  // ===== Bus robusto
  function makeBus(name, onMessage){
    const HAS_BC='BroadcastChannel'in window;
    if(HAS_BC){ const bc=new BroadcastChannel(name); if(onMessage) bc.onmessage=(e)=>onMessage(e.data||{}); return {post:(d)=>bc.postMessage(d),close:()=>bc.close()}; }
    else { if(onMessage){ window.addEventListener('storage',(e)=>{ if(e.key===name&&e.newValue){ try{ onMessage(JSON.parse(e.newValue)); }catch(_){ } } }); } return {post:(d)=>{try{localStorage.setItem(name,JSON.stringify(d));}catch(_){ }},close:()=>{}}; }
  }
  const bus = makeBus('pagoyo_demo');

  // ===== Utiles
  const numToEuro = n => (n||0).toFixed(2).replace('.',',')+' €';
  const euroToNum = s => parseFloat((s||'0').toString().replace(/\./g,'').replace(',','.').replace(/[^\d.]/g,''))||0;

  // Totales
  const tpvEl=document.getElementById('tpvTotal');
  const paidEl=document.getElementById('paidTotal');
  const pendingEl=document.getElementById('pendingTotal');
  let totalTPV = euroToNum(tpvEl.textContent); // 0
  let totalPaid=0;
  let pending =0;

  function refreshTotals(){
    paidEl.textContent = numToEuro(totalPaid);
    pending = Math.max(0, totalTPV - totalPaid);
    pendingEl.textContent = numToEuro(pending);
  }
  refreshTotals();

  // Pagos
  const paymentsList=document.getElementById('paymentsList');
  const paymentsCard=document.getElementById('paymentsCard');
  const banner=document.getElementById('banner');

  function addPendingRow(data){
    const tr=document.createElement('tr');
    const detail=(data.items||[]).map(i=>`${i.qty}× ${i.name}`).join(' · ');
    tr.innerHTML=`
      <td>${data.code||'Parcial'}</td>
      <td>${detail||'-'}</td>
      <td>${data.method||'-'}</td>
      <td>${data.amount||'0,00 €'}</td>
      <td><button class="btn mark">Marcar cobrado</button></td>`;
    paymentsList.appendChild(tr);
    paymentsCard.classList.add('flash'); setTimeout(()=>paymentsCard.classList.remove('flash'),600);

    tr.querySelector('.mark').addEventListener('click', ()=>{
      const amt = euroToNum(data.amount||'0');
      totalPaid += amt;
      refreshTotals();
      tr.querySelector('.mark').disabled = true;
      tr.querySelector('.mark').textContent = 'Cobrado';
      tr.querySelector('.mark').style.opacity='.6';
    });
  }

  // Selector de mesa
  const pillMesa=document.getElementById('pillMesa');
  const pillEstado=document.getElementById('pillEstado');
  document.getElementById('mesaSelect').addEventListener('change', ()=>{
    const m=document.getElementById('mesaSelect').value;
    pillMesa.textContent=m; pillEstado.textContent='esperando ticket…';
    paymentsList.innerHTML='';
    totalTPV=0; totalPaid=0; pending=0;
    tpvEl.textContent=numToEuro(0); paidEl.textContent=numToEuro(0); pendingEl.textContent=numToEuro(0);
    if (banner) banner.style.display='none';
  });

  // Escuchar TPV + Cliente
  makeBus('pagoyo_demo', (data)=>{
    const msel=document.getElementById('mesaSelect').value;
    if (data.mesa && data.mesa !== msel) return;

    if (data.type==='partial_confirmed') addPendingRow(data);

    if (data.type==='tpv_ticket_update'){
      tpvEl.textContent = data.total || numToEuro(0);
      totalTPV = euroToNum(tpvEl.textContent);
      totalPaid = 0;
      paymentsList.innerHTML='';
      pillEstado.textContent='sincronizado';
      paymentsCard.classList.add('flash'); setTimeout(()=>paymentsCard.classList.remove('flash'),600);
      if (banner) banner.style.display='none';
      refreshTotals();
    }

    if (data.type==='tpv_ticket_close'){
      if (banner) banner.style.display='block';
      pillEstado.textContent='ticket cerrado';
    }
  });

  // Reset demo
  document.getElementById('resetBtn').addEventListener('click', ()=>{
    paymentsList.innerHTML='';
    totalTPV=0; totalPaid=0; pending=0;
    tpvEl.textContent=numToEuro(0); paidEl.textContent=numToEuro(0); pendingEl.textContent=numToEuro(0);
    if (banner) banner.style.display='none';
  });
  </script>
</body>
</html>
