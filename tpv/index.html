<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PagoYo — TPV Simulado</title>
  <link rel="manifest" href="/pagoyo-demo/manifest.webmanifest">
<meta name="theme-color" content="#0F766E">
<link rel="icon" href="/pagoyo-demo/icons/pagoyo-192.png">

  <style>
    :root{--teal:#0F766E;--bg:#F4F6F8}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,Arial,sans-serif;color:#111;background:#fff}
    header{background:var(--teal);color:#fff;padding:12px}
    header .bar{max-width:920px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:8px}
    main{max-width:920px;margin:0 auto;padding:16px;display:grid;gap:12px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:14px;box-shadow:0 1px 4px rgba(0,0,0,.06)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px} .row{display:flex;gap:8px;align-items:center;justify-content:space-between;margin:6px 0}
    .btn{background:var(--teal);color:#fff;border:none;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}
    .btn.alt{background:#111} .btn.warn{background:#e11d48} .btn.mute{background:#9ca3af}
    select{border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left} th{color:#0F766E} .right{text-align:right}
    @media(max-width:780px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <strong>PagoYo — TPV Simulado</strong>
      <a href="../" style="color:#fff;text-decoration:none">⬅ Volver</a>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="row">
        <div>
          <label for="mesa">Mesa</label>
          <select id="mesa">
            <option value="6" selected>Mesa 6</option>
            <option value="5">Mesa 5</option>
            <option value="4">Mesa 4</option>
          </select>
        </div>
        <div>Este TPV envía actualizaciones a Cliente/Camarero (demo)</div>
      </div>
    </section>

    <section class="grid">
      <div class="card">
        <h3 style="margin-top:0;color:#0F766E">Añadir consumiciones</h3>
        <div class="row">
          <button class="btn add" data-name="Caña" data-price="1.80">+ Caña (1,80 €)</button>
          <button class="btn add" data-name="Refresco" data-price="2.20">+ Refresco (2,20 €)</button>
        </div>
        <div class="row">
          <button class="btn add" data-name="Ración Calamares" data-price="9.50">+ Calamares (9,50 €)</button>
          <button class="btn add" data-name="Ración Patatas" data-price="6.00">+ Patatas (6,00 €)</button>
        </div>
        <div class="row">
          <button class="btn add" data-name="Tarta de Queso" data-price="4.50">+ Tarta (4,50 €)</button>
          <button class="btn add" data-name="Café" data-price="1.50">+ Café (1,50 €)</button>
        </div>
        <div class="row">
          <button id="btnPreset" class="btn alt">Cargar ticket de ejemplo</button>
          <button id="btnClear" class="btn mute">Limpiar ticket</button>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0;color:#0F766E">Ticket mesa <span id="mesaLabel">6</span></h3>
        <table>
          <thead>
            <tr><th>Artículo</th><th class="right">Precio</th><th class="right">Ud.</th><th class="right">Importe</th><th></th></tr>
          </thead>
          <tbody id="tbody"></tbody>
          <tfoot>
            <tr><th colspan="3" class="right">Total TPV</th><th id="totalCell" class="right">0,00 €</th><th></th></tr>
          </tfoot>
        </table>
        <div class="row">
          <button id="btnUpdate" class="btn">Enviar a sala (actualizar ticket)</button>
          <button id="btnClose" class="btn warn">Cerrar ticket</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ==== Canal robusto (BroadcastChannel con fallback a localStorage) ====
    function makeBus(name, onMessage){
      const HAS_BC = 'BroadcastChannel' in window;
      if (HAS_BC) {
        const bc = new BroadcastChannel(name);
        if (onMessage) bc.onmessage = (e)=>onMessage(e.data || {});
        return { post:(data)=>bc.postMessage(data), close:()=>bc.close() };
      } else {
        if (onMessage) {
          window.addEventListener('storage', (e)=>{
            if (e.key === name && e.newValue) {
              try { onMessage(JSON.parse(e.newValue)); } catch(_){}
            }
          });
        }
        return { post:(data)=>{ try{ localStorage.setItem(name, JSON.stringify(data)); }catch(_){ } }, close:()=>{} };
      }
    }
    const bus = makeBus('pagoyo_demo');

    // € utils y estado
    const fmt = n => n.toFixed(2).replace('.', ',') + ' €';
    const tbody = document.getElementById('tbody');
    const totalCell = document.getElementById('totalCell');
    const mesaSel = document.getElementById('mesa');
    const mesaLabel = document.getElementById('mesaLabel');
    const items = []; // {name, price, qty}

    function render(){
      tbody.innerHTML = '';
      let total = 0;
      items.forEach((it, idx)=>{
        const imp = it.price * it.qty; total += imp;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${it.name}</td>
          <td class="right">${fmt(it.price)}</td>
          <td class="right">
            <button data-act="-" data-idx="${idx}">−</button>
            <span style="display:inline-block;min-width:24px;text-align:center">${it.qty}</span>
            <button data-act="+" data-idx="${idx}">+</button>
          </td>
          <td class="right">${fmt(imp)}</td>
          <td class="right"><button data-act="rm" data-idx="${idx}" style="background:#ef4444;color:#fff;border:none;border-radius:8px;padding:4px 8px">Eliminar</button></td>`;
        tbody.appendChild(tr);
      });
      totalCell.textContent = fmt(total);
      mesaLabel.textContent = mesaSel.value;
    }

    // + / - / eliminar
    tbody.addEventListener('click', e=>{
      const act = e.target.dataset.act; if(!act) return;
      const idx = parseInt(e.target.dataset.idx,10); const it = items[idx]; if(!it) return;
      if(act==='+') it.qty++;
      if(act==='-'){ it.qty = Math.max(0,it.qty-1); if(it.qty===0) items.splice(idx,1); }
      if(act==='rm') items.splice(idx,1);
      render();
    });

    // Add buttons
    document.querySelectorAll('.add').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const name = btn.dataset.name;
        const price = parseFloat(btn.dataset.price);
        const found = items.find(i=>i.name===name && i.price===price);
        if(found){ found.qty++; } else { items.push({name, price, qty:1}); }
        render();
      });
    });

    // Enviar actualización (SIEMPRE con mesa)
    document.getElementById('btnUpdate').addEventListener('click', ()=>{
      const mesa = mesaSel ? mesaSel.value : "6";
      bus.post({
        type: 'tpv_ticket_update',
        mesa,
        items: items.map(i=>({name:i.name, price:i.price, qty:i.qty})),
        total: totalCell.textContent
      });
      alert('Ticket enviado a sala.');
    });

    // Cerrar ticket (SIEMPRE con mesa)
    document.getElementById('btnClose').addEventListener('click', ()=>{
      const mesa = mesaSel ? mesaSel.value : "6";
      bus.post({ type:'tpv_ticket_close', mesa });
      alert('Ticket cerrado.');
      items.length = 0; render();
    });

    // Preset (y EMITIR)
    document.getElementById('btnPreset').addEventListener('click', ()=>{
      items.length = 0;
      const add=(n,p,q)=>items.push({name:n,price:p,qty:q});
      add('Caña',1.80,2); add('Refresco',2.20,2); add('Ración Calamares',9.50,1);
      add('Ración Patatas',6.00,1); add('Tarta de Queso',4.50,2);
      render();

      const mesa = mesaSel ? mesaSel.value : "6";
      bus.post({
        type: 'tpv_ticket_update',
        mesa,
        items: items.map(i=>({name:i.name, price:i.price, qty:i.qty})),
        total: totalCell.textContent
      });
    });

    // Limpiar
    document.getElementById('btnClear').addEventListener('click', ()=>{
      items.length = 0; render();
      const mesa = mesaSel ? mesaSel.value : "6";
      bus.post({ type: 'tpv_ticket_update', mesa, items: [], total: totalCell.textContent });
    });

    // Cambio de mesa: actualizar rótulo y EMITIR
    mesaSel.addEventListener('change', ()=>{
      mesaLabel.textContent = mesaSel.value;
      bus.post({
        type: 'tpv_ticket_update',
        mesa: mesaSel.value,
        items: items.map(i=>({name:i.name, price:i.price, qty:i.qty})),
        total: totalCell.textContent
      });
    });

    render();
  </script>
</body>
</html>
